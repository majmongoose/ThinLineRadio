<div class="auth-screen">
  <div class="auth-container">
    <!-- Blocked Message with Countdown -->
    <div *ngIf="isBlocked" style="text-align: center; padding: 40px 20px;">
      <div style="font-size: 48px; margin-bottom: 20px;">ðŸ”’</div>
      <h2 style="color: #d32f2f; margin-bottom: 16px;">Too Many Failed Attempts</h2>
      <p style="margin-bottom: 24px;">Your IP address has been temporarily blocked due to multiple failed login attempts.</p>
      <div style="font-size: 48px; font-weight: bold; color: #667eea; margin-bottom: 16px;">
        {{ getCountdownDisplay() }}
      </div>
      <p style="color: #666;">Please wait before trying again.</p>
    </div>

    <div *ngIf="!isBlocked">
      <div class="auth-header">
        <img *ngIf="!logoError && logoUrl" 
             [src]="logoUrl" 
             [style.border-radius]="getLogoBorderRadius()"
             class="auth-logo"
             alt="Logo"
             (error)="onLogoError($event)"
             (load)="logoError = false">
        <h1>{{ getBranding() }}</h1>
        <p *ngIf="isUserRegistrationEnabled()">Sign in to your account or create a new one</p>
        <p *ngIf="!isUserRegistrationEnabled()">Sign in to your account</p>
      </div>

      <div class="auth-tabs">
      <button type="button" 
              [class.active]="authMode === 'login'" 
              (click)="setAuthMode('login')">
        Sign In
      </button>
      <button type="button" 
              *ngIf="isUserRegistrationEnabled()"
              [class.active]="authMode === 'register'" 
              (click)="setAuthMode('register')">
        Sign Up
      </button>
      <button type="button" 
              [class.active]="authMode === 'group-admin'" 
              (click)="setAuthMode('group-admin')">
        Group Management
      </button>
    </div>

    <!-- Login Form -->
    <div class="auth-form" *ngIf="authMode === 'login'">
      <form [formGroup]="loginForm" (ngSubmit)="onLogin()">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email</mat-label>
          <input matInput type="email" formControlName="email" required autocomplete="email">
          <mat-error *ngIf="loginForm.get('email')?.hasError('required')">
            Email is required
          </mat-error>
          <mat-error *ngIf="loginForm.get('email')?.hasError('email')">
            Please enter a valid email address
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Password</mat-label>
          <input matInput type="password" formControlName="password" required autocomplete="current-password">
          <mat-error *ngIf="loginForm.get('password')?.hasError('required')">
            Password is required
          </mat-error>
        </mat-form-field>

        <div class="error-message" *ngIf="error">
          {{ error }}
        </div>

        <!-- Cloudflare Turnstile Widget -->
        <div *ngIf="turnstileEnabled && turnstileSiteKey" style="margin: 20px 0; display: flex; justify-content: center;">
          <div id="turnstile-widget-auth"></div>
        </div>

        <div style="text-align: center; margin-top: 8px; margin-bottom: 16px;">
          <a href="#" (click)="onForgotPassword(); $event.preventDefault()" 
             style="color: #666; text-decoration: none; font-size: 14px;">
            Forgot Password?
          </a>
        </div>

        <button mat-raised-button color="primary" type="submit" 
                [disabled]="loading || (turnstileEnabled && !turnstileToken)" class="full-width">
          <mat-spinner diameter="20" *ngIf="loading"></mat-spinner>
          <span *ngIf="!loading">Sign In</span>
        </button>
      </form>
    </div>

    <!-- Forgot Password Form -->
    <div class="auth-form" *ngIf="showForgotPassword && !showResetPassword">
      <h3 style="margin-bottom: 20px;">Reset Password</h3>
      <p style="color: #666; margin-bottom: 20px;">
        Enter your email address and we'll send you a verification code to reset your password.
      </p>

      <form [formGroup]="forgotPasswordForm" (ngSubmit)="onRequestReset()">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email</mat-label>
          <input matInput type="email" formControlName="email" required>
          <mat-error *ngIf="forgotPasswordForm.get('email')?.hasError('required')">
            Email is required
          </mat-error>
          <mat-error *ngIf="forgotPasswordForm.get('email')?.hasError('email')">
            Please enter a valid email address
          </mat-error>
        </mat-form-field>

        <div class="error-message" *ngIf="error">
          {{ error }}
        </div>

        <button mat-raised-button color="primary" type="submit" 
                [disabled]="forgotPasswordForm.invalid || loading" class="full-width">
          <mat-spinner diameter="20" *ngIf="loading"></mat-spinner>
          <span *ngIf="!loading">Send Verification Code</span>
        </button>

        <div style="text-align: center; margin-top: 16px;">
          <a href="#" (click)="backToLogin(); $event.preventDefault()" 
             style="color: #666; text-decoration: none; font-size: 14px;">
            Back to Login
          </a>
        </div>
      </form>
    </div>

    <!-- Reset Password Form -->
    <div class="auth-form" *ngIf="showResetPassword">
      <h3 style="margin-bottom: 20px;">Enter Verification Code</h3>
      <p style="color: #666; margin-bottom: 20px;">
        We've sent a 6-digit verification code to <strong>{{ resetEmail }}</strong>. 
        Enter the code below along with your new password.
      </p>

      <form [formGroup]="resetPasswordForm" (ngSubmit)="onResetPassword()">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Verification Code</mat-label>
          <input matInput type="text" formControlName="code" 
                 placeholder="000000" maxlength="6" required>
          <mat-hint>Enter the 6-digit code from your email</mat-hint>
          <mat-error *ngIf="resetPasswordForm.get('code')?.hasError('required')">
            Verification code is required
          </mat-error>
          <mat-error *ngIf="resetPasswordForm.get('code')?.hasError('pattern')">
            Code must be 6 digits
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>New Password</mat-label>
          <input matInput type="password" formControlName="newPassword" required>
          <mat-error *ngIf="resetPasswordForm.get('newPassword')?.hasError('required')">
            New password is required
          </mat-error>
          <mat-error *ngIf="resetPasswordForm.get('newPassword')?.hasError('minlength')">
            Password must be at least 8 characters
          </mat-error>
          <mat-error *ngIf="resetPasswordForm.get('newPassword')?.hasError('requireUpper')">
            Password must contain at least one uppercase letter
          </mat-error>
          <mat-error *ngIf="resetPasswordForm.get('newPassword')?.hasError('requireLower')">
            Password must contain at least one lowercase letter
          </mat-error>
          <mat-error *ngIf="resetPasswordForm.get('newPassword')?.hasError('requireNumber')">
            Password must contain at least one number
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Confirm Password</mat-label>
          <input matInput type="password" formControlName="confirmPassword" required>
          <mat-error *ngIf="resetPasswordForm.get('confirmPassword')?.hasError('required')">
            Please confirm your password
          </mat-error>
          <mat-error *ngIf="resetPasswordForm.get('confirmPassword')?.hasError('passwordMismatch')">
            Passwords do not match
          </mat-error>
        </mat-form-field>

        <div class="error-message" *ngIf="error">
          {{ error }}
        </div>

        <button mat-raised-button color="primary" type="submit" 
                [disabled]="resetPasswordForm.invalid || loading" class="full-width">
          <mat-spinner diameter="20" *ngIf="loading"></mat-spinner>
          <span *ngIf="!loading">Reset Password</span>
        </button>

        <div style="text-align: center; margin-top: 16px;">
          <a href="#" (click)="backToLogin(); $event.preventDefault()" 
             style="color: #666; text-decoration: none; font-size: 14px;">
            Back to Login
          </a>
        </div>
      </form>
    </div>

    <!-- Registration Form -->
    <div class="auth-form" *ngIf="authMode === 'register' && isUserRegistrationEnabled()">
      
      <!-- Invite Only Notice -->
      <div class="invite-only-notice" *ngIf="isInviteOnlyMode && !success" style="padding: 15px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <mat-icon style="color: #856404;">info</mat-icon>
          <strong style="color: #856404;">Registration is by invitation only - you need a valid invitation or registration code to create an account.</strong>
        </div>
      </div>
      
      <!-- Code Validation Step (Invite-Only Mode) -->
      <div class="code-validation-step" *ngIf="isInviteOnlyMode && !codeValidated && !success">
        <p style="margin-bottom: 20px;">Enter your invitation or registration code to continue:</p>
        
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Invitation/Registration Code</mat-label>
          <input matInput type="text" [(ngModel)]="pendingAccessCode" placeholder="Enter your code" required>
        </mat-form-field>

        <div class="error-message" *ngIf="codeValidationError" style="margin-bottom: 15px;">
          {{ codeValidationError }}
        </div>

        <button mat-raised-button color="primary" (click)="validateAccessCode()" 
                [disabled]="!pendingAccessCode || validatingCode" class="full-width">
          <mat-spinner diameter="20" *ngIf="validatingCode"></mat-spinner>
          <span *ngIf="!validatingCode">Validate Code</span>
        </button>
      </div>
      
      <!-- Code Validated Success Message -->
      <div class="code-validated-notice" *ngIf="isInviteOnlyMode && codeValidated && !success" style="padding: 15px; background-color: #d4edda; border: 1px solid #28a745; border-radius: 4px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <mat-icon style="color: #155724;">check_circle</mat-icon>
          <strong style="color: #155724;">Invite Code Validated, Please Fill Out the Form</strong>
        </div>
      </div>
      
      <!-- Public Registration Group Info (only show when NOT invite-only mode) -->
      <div class="public-registration-info" *ngIf="!success && !isInviteOnlyMode">
        <div class="info-section" *ngIf="publicGroupInfo?.name">
          <h3>{{ publicGroupInfo.name }}</h3>
          <p *ngIf="publicGroupInfo?.description">{{ publicGroupInfo.description }}</p>
        </div>
        
        <!-- Pricing Information -->
        <div class="pricing-section" *ngIf="publicGroupInfo?.billingEnabled && publicGroupInfo?.pricingOptions && publicGroupInfo.pricingOptions.length > 0">
          <h4>Pricing Plans</h4>
          <div class="pricing-options">
            <div class="pricing-option" *ngFor="let option of publicGroupInfo.pricingOptions">
              <div class="pricing-label">{{ option.label }}</div>
              <div class="pricing-amount">{{ option.amount }}</div>
            </div>
          </div>
        </div>
        
        <!-- Available Channels - Only in public mode -->
        <div class="channels-section" *ngIf="!isInviteOnlyMode">
          <button mat-button type="button" (click)="toggleChannels()" class="channels-toggle">
            <mat-icon>{{ showChannels ? 'expand_less' : 'expand_more' }}</mat-icon>
            <span>View Available Channels ({{ availableChannels.length }})</span>
          </button>
          
          <div class="channels-list" *ngIf="showChannels && !loadingChannels">
            <div *ngIf="availableChannels.length === 0" class="no-channels">
              <p>No channels available at this time.</p>
            </div>
            <div class="channel-item" *ngFor="let system of availableChannels">
              <div class="system-header">
                <strong>{{ system.label }}</strong>
                <span class="talkgroup-count" *ngIf="system.talkgroups">
                  ({{ system.talkgroups.length }} channel{{ system.talkgroups.length !== 1 ? 's' : '' }})
                </span>
              </div>
              <div class="talkgroups-list" *ngIf="system.talkgroups && system.talkgroups.length > 0">
                <!-- Group by tag -->
                <div class="talkgroup-group" *ngFor="let tagGroup of getTalkgroupsByTag(system.talkgroups)">
                  <div class="tag-header" *ngIf="tagGroup.tag">
                    <strong>{{ tagGroup.tag }}</strong>
                  </div>
                  <div class="talkgroup-items">
                    <div class="talkgroup-item" *ngFor="let tg of tagGroup.talkgroups">
                      <span class="talkgroup-label">{{ tg.label }}</span>
                      <span class="talkgroup-description" *ngIf="tg.description">{{ tg.description }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div *ngIf="loadingChannels" class="loading-channels">
            <mat-spinner diameter="24"></mat-spinner>
            <span>Loading channels...</span>
          </div>
        </div>
      </div>
      
      <!-- Registration Form (shown after code validation in invite-only, or immediately in public mode) -->
      <form [formGroup]="registerForm" (ngSubmit)="onRegister()" *ngIf="!success && (!isInviteOnlyMode || codeValidated)">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>First Name</mat-label>
          <input matInput type="text" formControlName="firstName" required>
          <mat-error *ngIf="registerForm.get('firstName')?.hasError('required')">
            First name is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Last Name</mat-label>
          <input matInput type="text" formControlName="lastName" required>
          <mat-error *ngIf="registerForm.get('lastName')?.hasError('required')">
            Last name is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>ZIP Code</mat-label>
          <input matInput type="text" formControlName="zipCode" placeholder="12345" required>
          <mat-error *ngIf="registerForm.get('zipCode')?.hasError('required')">
            ZIP code is required
          </mat-error>
          <mat-error *ngIf="registerForm.get('zipCode')?.hasError('pattern')">
            Please enter a valid ZIP code (12345 or 12345-6789)
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email</mat-label>
          <input matInput type="email" formControlName="email" required>
          <mat-error *ngIf="registerForm.get('email')?.hasError('required')">
            Email is required
          </mat-error>
          <mat-error *ngIf="registerForm.get('email')?.hasError('email')">
            Please enter a valid email address
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Password</mat-label>
          <input matInput type="password" formControlName="password" required>
          <mat-error *ngIf="registerForm.get('password')?.hasError('required')">
            Password is required
          </mat-error>
          <mat-error *ngIf="registerForm.get('password')?.hasError('minlength')">
            Password must be at least 8 characters
          </mat-error>
          <mat-error *ngIf="registerForm.get('password')?.hasError('requireUpper')">
            Password must contain at least one uppercase letter
          </mat-error>
          <mat-error *ngIf="registerForm.get('password')?.hasError('requireLower')">
            Password must contain at least one lowercase letter
          </mat-error>
          <mat-error *ngIf="registerForm.get('password')?.hasError('requireNumber')">
            Password must contain at least one number
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Confirm Password</mat-label>
          <input matInput type="password" formControlName="confirmPassword" required>
          <mat-error *ngIf="registerForm.get('confirmPassword')?.hasError('required')">
            Please confirm your password
          </mat-error>
          <mat-error *ngIf="registerForm.get('confirmPassword')?.hasError('passwordMismatch')">
            Passwords do not match
          </mat-error>
        </mat-form-field>

        <!-- Invite Code field (only show in public mode) -->
        <mat-form-field appearance="outline" class="full-width" *ngIf="!isInviteOnlyMode && !registerForm.get('accessCode')?.value">
          <mat-label>Invite Code (Optional)</mat-label>
          <input matInput type="text" formControlName="accessCode" placeholder="Enter invite code if you have one">
          <mat-hint>If you received an invite code, enter it here.</mat-hint>
        </mat-form-field>
        
        <!-- Hidden field when code already validated in invite-only mode -->
        <input type="hidden" formControlName="accessCode" *ngIf="isInviteOnlyMode && codeValidated">

        <div class="error-message" *ngIf="error">
          {{ error }}
        </div>

        <!-- Cloudflare Turnstile Widget (hidden when using invitation code) -->
        <div *ngIf="turnstileEnabled && turnstileSiteKey && shouldShowTurnstile()" style="margin: 20px 0; display: flex; justify-content: center;">
          <div id="turnstile-widget-auth"></div>
        </div>
        
        <!-- Info message when Turnstile is skipped for invitations -->
        <div *ngIf="turnstileEnabled && !shouldShowTurnstile()" style="margin: 20px 0; padding: 12px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px;">
          <div style="display: flex; align-items: center; gap: 8px; color: #2e7d32;">
            <mat-icon style="font-size: 20px; width: 20px; height: 20px;">shield</mat-icon>
            <span style="font-size: 14px;">CAPTCHA verification skipped - using validated invitation code</span>
          </div>
        </div>

        <div class="success-message" *ngIf="success">
          <mat-icon>check_circle</mat-icon>
          <p>{{ successMessage }}</p>
          <button mat-button type="button" (click)="resendVerification()">
            Resend verification email
          </button>
        </div>

        <button mat-raised-button color="primary" type="submit" 
                [disabled]="registerForm.invalid || loading || (turnstileEnabled && !turnstileToken && !registerForm.get('invitationCode')?.value)" class="full-width">
          <mat-spinner diameter="20" *ngIf="loading"></mat-spinner>
          <span *ngIf="!loading">Sign Up</span>
        </button>
      </form>
    </div>

    <!-- Stripe Checkout -->
    <div class="checkout-overlay" *ngIf="showCheckout">
      <div class="checkout-backdrop" (click)="onCheckoutCancel()"></div>
      <div class="checkout-modal">
        <rdio-scanner-stripe-checkout
          *ngIf="config"
          [config]="config"
          [email]="loginForm.get('email')?.value"
          (checkoutSuccess)="onCheckoutSuccess($event)"
          (checkoutError)="onCheckoutError($event)"
          (checkoutCancel)="onCheckoutCancel()">
        </rdio-scanner-stripe-checkout>
      </div>
    </div>

    <!-- Checkout Success Modal -->
    <div class="checkout-overlay" *ngIf="showCheckoutSuccess">
      <div class="checkout-backdrop" (click)="closeCheckoutSuccess()"></div>
      <div class="checkout-modal">
        <div class="checkout-success">
          <div class="success-icon">
            <mat-icon>check_circle</mat-icon>
          </div>
          <h2>Subscription Successful!</h2>
          <p>Your subscription has been activated. You can now log in to access all features.</p>
          <button mat-raised-button color="primary" (click)="closeCheckoutSuccess()">
            Continue
          </button>
        </div>
      </div>
    </div>

    <!-- Checkout Cancel Modal -->
    <div class="checkout-overlay" *ngIf="showCheckoutCancel">
      <div class="checkout-backdrop" (click)="closeCheckoutCancel()"></div>
      <div class="checkout-modal">
        <div class="checkout-cancel">
          <div class="cancel-icon">
            <mat-icon>cancel</mat-icon>
          </div>
          <h2>Checkout Cancelled</h2>
          <p>Your subscription was not completed. You can try again anytime.</p>
          <button mat-raised-button color="primary" (click)="closeCheckoutCancel()">
            Continue
          </button>
        </div>
      </div>
    </div>

    <!-- Group Admin Login -->
    <div class="auth-form" *ngIf="authMode === 'group-admin'">
      <p class="group-admin-description">Group administrators can manage their group settings, users, and registration codes.</p>
      <form [formGroup]="groupAdminForm" (ngSubmit)="onGroupAdminLogin()">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email</mat-label>
          <input matInput type="email" formControlName="email" required>
          <mat-error *ngIf="groupAdminForm.get('email')?.hasError('required')">
            Email is required
          </mat-error>
          <mat-error *ngIf="groupAdminForm.get('email')?.hasError('email')">
            Please enter a valid email address
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Password</mat-label>
          <input matInput type="password" formControlName="password" required>
          <mat-error *ngIf="groupAdminForm.get('password')?.hasError('required')">
            Password is required
          </mat-error>
        </mat-form-field>

        <!-- Cloudflare Turnstile Widget -->
        <div *ngIf="turnstileEnabled && turnstileSiteKey" style="margin: 20px 0; display: flex; justify-content: center;">
          <div id="turnstile-widget-auth"></div>
        </div>

        <div class="error-message" *ngIf="groupAdminError">
          {{ groupAdminError }}
        </div>

        <button mat-raised-button color="primary" type="submit" 
                [disabled]="groupAdminForm.invalid || groupAdminLoading || (turnstileEnabled && !turnstileToken)" class="full-width">
          <mat-spinner diameter="20" *ngIf="groupAdminLoading"></mat-spinner>
          <span *ngIf="!groupAdminLoading">Sign In</span>
        </button>
      </form>
    </div>

    </div>
    <!-- End !isBlocked wrapper -->

    <!-- Support Section -->
    <div class="support-section">
      <p class="support-text" *ngIf="hasSupportEmail()">
        Need help? Contact us at 
        <a [href]="'mailto:' + getSupportEmail()" class="support-link">{{ getSupportEmail() }}</a>
      </p>
      <p class="no-support-text" *ngIf="!hasSupportEmail()">
        The owner of this server has not provided email support.
      </p>
    </div>
  </div>
</div>
